<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>首页</title>
    <link rel="stylesheet" href="../common/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../common/font-awesome-4.7.0/css/font-awesome.css" />
    <link rel="stylesheet" href="../common/header.css" />
    <link rel="stylesheet" href="/PCAdmin/css/teacherHome.css" />
    <script src="../common/jquery-2.1.1.min.js"></script>
    <script src="../common/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/PCAdmin/js/template.js" ></script>
    <script type="text/javascript" src="../common/header.js" ></script>
    <script type="text/javascript" src="/PCAdmin/js/public.js"></script>
    <script type="text/javascript" src="/PCAdmin/js/teacher.js"></script>
</head>
<style>
    * {margin: 0;padding: 0;}
    .site-header{min-height: 80px;}
    section{padding: 0 10px;max-width: 1200px;margin:0 auto;margin-top: 20px;}
    .topCon {display: flex;height: 300px;padding: 20px;background: #F2F2F2;}
    .topCon .img {flex: 1;}
    .topCon .img img {width: 100%;height: 100%;}
    .topCon .intro {flex: 0 65%;padding-left: 20px;}
    .topCon .intro .name {font-size: 20px;font-weight: 700;padding-top: 30px;padding-bottom: 20px;}
    .topCon .intro div:nth-child(2) {padding-bottom: 20px;}
    .topCon .intro div:nth-child(2) span {margin-right: 10px;}
    .topCon .intro div:nth-child(2) span {margin-right: 10px;}
    .topCon .intro .price {padding-bottom: 20px;font-size: 20px;}
    .topCon .intro .book {padding: 5px 15px;border: 0;color: #FFFFFF;background: #BDB76B;}
    .classMenu {background: #e5e5e5;}
    .classMenu ul {display: flex;flex-direction: row;padding: 10px 20px;}
    .classMenu ul li.hover {background: #122B40;color: #fff;}
    .classMenu ul li {margin-right: 15px;padding: 5px 10px;border-radius: 5px;cursor: pointer;}
    .contentPart .content {background: #F2F2F2;padding: 20px;}
    .studentList li{height: 60px;line-height: 60px;background: #fff;padding: 0 20px;border-radius: 5px;margin-bottom: 10px;}
    .studentList  li div.fl img{width: 50px;border-radius: 50%;margin-right: 20px;}
    .studentList  li div.fr button{margin-left: 20px;}
    .nextClassTime{margin-left: 20px;color: #de5f55}
</style>
<body>
<header class="site-header">
    <div class="navBar">
        <nav>
            <a href="../common/index.html" class="webName"><span>琴行</span>Machold Rare Violins</a>
            <ul class="headUL">
                <li><a href="../common/index.html">首页</a></li>
                <li><a href="../common/class.html">课程</a></li>
                <li><a href="../common/knowledge.html">知识</a></li>
                <li><a href="../common/aboutUs.html">关于我们</a></li>
                <li class="none"><button class="btn btn-log">登陆</button></li>
                <li class="none"><button class="btn btn-log">注册</button></li>
                <li class="showName none">
                    <a href="javascript:;" class="active">Cynthia</a>
                </li>
                <li class="afterLog none">
                    <a href="javascript:;" class="logOut">退出</a>
                </li>
                <!--<li class="showName"><a href="myClass.html" class="active">Cynthia</a></li>-->
            </ul>
            <div class="listNav"><i class="fa fa-bars"></i></div>
        </nav>
    </div>
</header>
<div class="sliderBar none">
    <ul class="slider-ul">
        <li><a href="../common/index.html" class="active">首页</a></li>
        <li><a href="../common/class.html">课程</a></li>
        <li><a href="../common/knowledge.html">知识</a></li>
        <li><a href="../common/aboutUs.html">关于我们</a></li>
        <li class="none"><button class="btn btn-log">登陆</button></li>
        <li class="none"><button class="btn btn-log">注册</button></li>
        <li class="showName"><a href="myClass.html" class="active">Cynthia</a></li>
    </ul>
</div>
<section>
    <div class="row">
        <div class="col-md-3 personalNav">
            <ul>
                <!-- <li>我的课表</li> -->
                <li>我的消息</li>
                <li>请假调课</li>
                <li>课程目录</li>
                <li class="on">我的课程</li>
                <li>个人设置</li>
            </ul>
        </div>
        <div class="col-md-9 contentPart">
        </div>
    </div>
</section>
<div class="alertBk none"></div>
<div class="alertMain none">
    <div class="dateChoosePart">
        <p class="title">请选择上课日期：</p>
        <p class="tip">注意：只能选择后面七天的时间</p>
        <ul class="dateList">
        </ul>
        <div class="clearfix">
            <button class="fl btn btn-warning closeBtn">关闭</button>
            <button class="fr btn nextTab">下一步</button>
        </div>
    </div>
    <div class="timeChoosePart none">
        <p class="title">请选择上课具体时间：</p>
        <p class="tip">注意：只能选择规定时间端的时间</p>
        <ul class="timeList">
            <li data-time="08:00:00">08:00</li>
            <li data-time="09:00:00">09:00</li>
            <li data-time="10:00:00">10:00</li>
            <li data-time="13:00:00">13:00</li>
            <li data-time="14:00:00">14:00</li>
            <li data-time="15:00:00">15:00</li>
            <li data-time="19:00:00">19:00</li>
            <li data-time="20:00:00">20:00</li>
        </ul>
        <div class="clearfix">
            <button class="fl btn btn-warning closeBtn">关闭</button>
            <button class="fr btn confirmTime">确认安排</button>
            <button class="fr btn btn-primary preTab">上一步</button>
        </div>
    </div>
</div>
<script id="courseDetail" type="text/html">
    <div class="row clearfix" style="margin: 10px 0 20px 0;">
        <button class="fl btn btn-primary goBack" style="background:#cdc9a5;border:0">返回</button>
    </div>
    <div class="courseDetail">
        <div class="topCon">
            <div class="img"><img src="/PCAdmin/img/course/{{item.banner}}"></div>
            <div class="intro">
                <div class="name">{{item.course_name}}</div>
                <div>
                    <span>老师: {{item.teacher_name}}</span>
                </div>
                <div>教师等级：{{item.teacher_rank}}</div>
            </div>
        </div>
        <div class="classMenu">
            <ul>
                <li class="hover">介绍</li>
                <li>目录</li>
                <li>学生名单</li>
            </ul>
        </div>
        <div class="content">
            <h3>课程概述</h3>
            <p>{{item.short_intro}}</p>
        </div>
        <div class="content none">
            <h3>课程目录</h3>
        </div>
        <div class="content none">
            <h3>学生名单</h3>
            <ul class="studentList">
            </ul>
        </div>
    </div>
</script>
</body>
<script>
    initDateList();
    var courseId = GetQueryString('courseId');
    getCourseInfo();
    function getCourseInfo(){
        $.ajax({
            url:'/PCAdmin/php/getCourseInfo.php',
            type:'post',
            dataType:'json',
            data: {
                id: courseId
            },
            success: function(res){
                if(res.success){
                    var item = res.data;
                    $.ajax({
                        url:'/PCAdmin/php/getUserInfo.php',
                        type: 'post',
                        dataType:'json',
                        aysnc: 'false',
                        data: {
                            id: item.teacher_id
                        },
                        success: function(result){
                            if(result.success){
                                item.teacher_name = result.data.name;
                                item.teacher_rank = result.data.teacher_rank;
                                var html = template('courseDetail',{item:item});
                                $('.contentPart').append(html);
                            }
                            $('.classMenu ul li').click(function() {
                                var index = $(this).index();
                                $('.classMenu ul li').removeClass('hover');
                                $(this).addClass('hover');
                                if(index==0){
                                    $('.courseDetail .content').addClass('none');
                                    $('.courseDetail .content:eq(0)').removeClass('none');
                                }
                                else if(index==1){
                                    getCatalogueList(courseId);
                                    $('.courseDetail .content').addClass('none');
                                    $('.courseDetail .content:eq(1)').removeClass('none');
                                }
                                else if(index==2){
                                    getStudentList(courseId)
                                    $('.courseDetail .content').addClass('none');
                                    $('.courseDetail .content:eq(2)').removeClass('none');
                                }
                            });
                        }
                    });
                }
            }
        });
    }

    function getCatalogueList(courseId){
        $.ajax({
            url: '/PCAdmin/php/getThisCatalogueList.php',
            type: 'post',
            dataType: 'json',
            data: {
                courseId: courseId
            },
            success: function(res){
                if(res.success){
                    if(res.list){
                        var list = res.list;
                        var html = '<h3>课程目录</h3>';
                        for(var i=0;i<list.length;i++){
                            if(list[i].has_homework){
                                html += '<p class="clearfix" style="line-height:34px;">课时'+list[i].sort_line+'：'+list[i].content+'<button data-catalogueId="'+list[i].id+'" class="fr btn hadHomework btn-warning">查看作业</button></p>';
                            }else{
                                html += '<p class="clearfix" style="line-height:34px;">课时'+list[i].sort_line+'：'+list[i].content+'<button data-catalogueId="'+list[i].id+'" class="fr btn noHomework btn-success">添加作业</button></p>';
                            }
                        }
                        $('.courseDetail .content:eq(1)').html(html);
                    }else{
                        var html = '<h3>课程目录</h3><p>暂未设置课程目录</p>';
                        $('.courseDetail .content:eq(1)').html(html);
                    }
                }
            }
        });
    }


    function getStudentList(courseId){
        $.ajax({
            url: '/PCAdmin/php/teacherGetStudentList.php',
            type: 'post',
            dataType: 'json',
            data: {
                courseId: courseId
            },
            success: function(res){
                if(res.success){
                    if(res.data&&res.data.length>0){
                        var list = res.data;
                        var html = '';
                        for(var i=0;i<list.length;i++){
                            if(list[i].leftTime==0){
                                html+='<li class="clearfix"><div class="fl"><img src="/PCAdmin/img/avatar/moren.jpg"><span>'+list[i].username+'</span><span class="nextClassTime">上次上课时间：'+list[i].class_time+'</span></div><div class="fr"><span>已完成全部课时</span></div></li>';
                                continue;
                            }
                            if(list[i].has_class==0){
                                if(list[i].class_time){
                                    html+='<li class="clearfix"><div class="fl"><img src="/PCAdmin/img/avatar/moren.jpg"><span>'+list[i].username+'</span><span class="nextClassTime">上次上课时间：'+list[i].class_time+'</span></div><div class="fr"><span>剩余课时数：'+list[i].leftTime+'</span><button data-orderId="'+list[i].order_id+'" data-studentId="'+list[i].user_id+'" class="btn btn-success">安排上课</button></div></li>';
                                }else{
                                    html+='<li class="clearfix"><div class="fl"><img src="/PCAdmin/img/avatar/moren.jpg"><span>'+list[i].username+'</span><span class="nextClassTime">暂无课程安排</span></div><div class="fr"><span>剩余课时数：'+list[i].leftTime+'</span><button data-orderId="'+list[i].order_id+'" data-studentId="'+list[i].user_id+'" class="btn btn-success">安排上课</button></div></li>';
                                }
                            }else{
                                var nowDate = getNowFormatDate();
                                var classDate = list[i].class_time.split(' ')[0];
                                if(nowDate<classDate){
                                    html+='<li class="clearfix"><div class="fl"><img src="/PCAdmin/img/avatar/moren.jpg"><span>'+list[i].username+'</span><span class="nextClassTime">下次上课时间：'+list[i].class_time+'</span></div><div class="fr"><span>剩余课时数：'+list[i].leftTime+'</span><button data-orderId="'+list[i].order_id+'" data-studentId="'+list[i].user_id+'" class="btn btn-warning">取消上课</button></div></li>';
                                }else{
                                    html+='<li class="clearfix"><div class="fl"><img src="/PCAdmin/img/avatar/moren.jpg"><span>'+list[i].username+'</span><span class="nextClassTime">本次上课时间：'+list[i].class_time+'</span></div><div class="fr"><span>剩余课时数：'+list[i].leftTime+'</span><button data-orderId="'+list[i].order_id+'" data-leftTime="'+list[i].leftTime+'" data-studentId="'+list[i].user_id+'" class="btn btn-primary">完成课程</button></div></li>';
                                }
                            }
                        }
                        $('.courseDetail .content:eq(2) .studentList').html(html);
                    }
                }else{
                    $('.courseDetail .content:eq(2) .studentList').html('<p>暂无购买该门课程的学生</p>');
                }
            }
        });
    }

    //  通知上课
    $(document).delegate('.courseDetail .content:eq(2) button.btn-success','click',function(){
        var orderId = $(this).attr('data-orderId');
        var studentId = $(this).attr('data-studentId');
        $('.alertMain').attr('data-orderId',orderId);
        $('.alertMain').attr('data-studentId',studentId);
        $('.alertBk').show();
        $('.alertMain').show();
    });

    //  取消上课
    $(document).delegate('.courseDetail .content:eq(2) button.btn-warning','click',function(){
        var orderId = $(this).attr('data-orderId');
        var studentId = $(this).attr('data-studentId');
        $.ajax({
            url: '/PCAdmin/php/cancelArrangeCourse.php',
            type: 'post',
            dataType: 'json',
            data: {
                orderId: orderId,
                teacherId: sessionStorage.getItem('userId'),
                studentId: studentId,
                messageCnt: '您好，你的《'+$('.courseDetail .intro .name').html()+'》课程老师由于个人原因取消了下一课时的上课安排，请您谅解，他会尽快为您安排新的上课时间的'
            },
            success: function(res){
                if(res.success){
                    getStudentList(courseId);
                }else{
                    alert('取消失败');
                }
            }
        });
    });

    //  完成课程
    $(document).delegate('.courseDetail .content:eq(2) button.btn-primary','click',function(){
        var orderId = $(this).attr('data-orderId');
        var studentId = $(this).attr('data-studentId');
        var leftTime = $(this).attr('data-leftTime');
        $.ajax({
            url: '/PCAdmin/php/finishArrangeCourse.php',
            type: 'post',
            dataType: 'json',
            data: {
                orderId: orderId,
                teacherId: sessionStorage.getItem('userId'),
                studentId: studentId,
                leftTime:leftTime,
                messageCnt: '你的《'+$('.courseDetail .intro .name').html()+'》已完成一次课时哦，具体课程进度请前往课程详情查看，如有错误请联系老师哦'
            },
            success: function(res){
                if(res.success){
                    getStudentList(courseId);
                }else{
                    alert('设置完成失败，请稍后再试');
                }
            }
        });
    });

    //  作业
    $(document).delegate('.courseDetail .content:eq(1) button','click',function () {
       var catalogue_id = $(this).attr('data-catalogueId');
       console.log(catalogue_id); 
       if($(this).hasClass('noHomework')){
            window.location.href = "addHomework.html?catalogueId="+catalogue_id;
       }else{
            window.location.href = "homeworkDetail.html?catalogueId="+catalogue_id;
       }
    });

    function initDateList(){
        var date = new Date();
        var html = '';
        for (var i = 1; i <= 7; i++) {
            date.setDate(date.getDate() + 1);
            var weekDay = ['日','一','二','三','四','五','六'];
            var str = date.getDay();
            var month = ('00'+ (date.getMonth()+1)).slice(-2);
            showDate = date.getFullYear() + '-' + month + '-' + date.getDate();
            chiDate = (date.getMonth() + 1) + '月' + date.getDate() +'日';
            html+='<li data-datetime="'+showDate+'">'+chiDate+'(周'+weekDay[str]+')</li>';
        }
        $('.alertMain .dateChoosePart .dateList').html(html);
    }


    //  日期选择弹窗工作
    $('.alertMain .dateChoosePart .dateList li').click(function(){
        var $this = $(this);
        if($this.hasClass('choose')){
            return;
        }
        $('.alertMain .dateChoosePart button').addClass('btn-primary');
        $this.addClass('choose').siblings().removeClass('choose');
    });
    $('.alertMain .timeChoosePart .timeList li').click(function(){
        var $this = $(this);
        if($this.hasClass('choose')){
            return;
        }
        $('.alertMain .timeChoosePart .confirmTime').addClass('btn-success');
        $this.addClass('choose').siblings().removeClass('choose');
    });
    $('.nextTab').click(function(){
        if(!$(this).hasClass('btn-primary')){
            return;
        }
        $('.alertMain .dateChoosePart').hide();
        $('.alertMain .timeChoosePart').show();
    });
    $('.preTab').click(function(){
        $('.alertMain .dateChoosePart').show();
        $('.alertMain .timeChoosePart').hide();
    });
    $('.confirmTime').click(function(){
        if(!$(this).hasClass('btn-success')){
            console.log('111111');
            return;
        }
        var date = $('.alertMain .dateChoosePart .dateList li.choose').attr('data-datetime');
        var time = $('.alertMain .timeChoosePart .timeList li.choose').attr('data-time');
        var datetime = date+' '+time;
        $.ajax({
            url: '/PCAdmin/php/arrangeCourseTime.php',
            type: 'post',
            dataType: 'json',
            data: {
                orderId: $('.alertMain').attr('data-orderId'),
                datetime: datetime,
                teacherId: sessionStorage.getItem('userId'),
                studentId: $('.alertMain').attr('data-studentId'),
                messageCnt: '您好，你的《'+$('.courseDetail .intro .name').html()+'》课程老师为您安排了下一课时的上课时间，上课时间为'+datetime+',请准时到达哦'
            },
            success: function(res){
                if(res.success){
                    $('.alertBk').hide();
                    $('.alertMain').hide();
                    getStudentList(courseId);
                }else{
                    $('.alertBk').hide();
                    $('.alertMain').hide();
                    alert('安排失败');
                }
            }
        });
    });
    $('.closeBtn').click(function(){
        $('.alertBk').hide();
        $('.alertMain').hide();
    });
    function getNowFormatDate(){
        var date = new Date();
        var month = ('00'+ (date.getMonth()+1)).slice(-2);
        showDate = date.getFullYear() + '-' + month + '-' + date.getDate();
        return showDate;
    }

    $(document).delegate('.goBack','click',function(){
        window.history.go(-1);
    });
</script>
</html>
